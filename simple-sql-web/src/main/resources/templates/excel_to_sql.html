<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head th:replace="~{fragments/site_head :: siteHead}"></head>
	<body>
		<div th:replace="~{fragments/layout_header :: layoutHeader}"></div>
		<div class="container">
			<div class="card">
				<h1>ğŸ“Š å°† Excel æ–‡ä»¶æ•°æ®è½¬æ¢ä¸º SQL è¯­å¥</h1>

				<div class="section">
					<div class="section-title">
						<strong>åŠŸèƒ½è¯´æ˜</strong>
					</div>
					<div class="feature-note">
						<div class="feature-row">
							<span class="feature-index">1</span>
							<span class="feature-text"
								>Excel ç¬¬ä¸€è¡Œå¡«å†™è¡¨çš„åˆ—åï¼Œç¬¬äºŒè¡Œå¼€å§‹æ˜¯è¡Œæ•°æ®</span
							>
						</div>
						<div class="feature-row">
							<span class="feature-index">2</span>
							<span class="feature-text">
								UPDATE / DELETE ç±»å‹æ—¶éœ€å¡«å†™ã€Œæ¡ä»¶åˆ—æ•°ã€ï¼Œå«ä¹‰æ˜¯æŒ‡å®šå‰ n åˆ—ä½œä¸º
								WHERE æ¡ä»¶
							</span>
						</div>
						<div class="feature-row">
							<span class="feature-index">3</span>
							<span class="feature-text">UPDATE æœªæ·»åŠ æ¡ä»¶åˆ—æ•°é»˜è®¤ä½¿ç”¨ 1</span>
						</div>
						<div class="feature-row">
							<span class="feature-index">4</span>
							<span class="feature-text"
								>DELETE æœªæ·»åŠ æ¡ä»¶åˆ—æ•°é»˜è®¤ä½¿ç”¨å…¨éƒ¨åˆ—</span
							>
						</div>
						<div class="feature-row">
							<span class="feature-index">5</span>
							<span class="feature-text">ç‚¹å‡» â€œå’»ï½ï½ï½â€ å¼€å§‹ç”Ÿæˆ</span>
						</div>
					</div>
				</div>

				<div class="section section-collapsible">
					<button
						type="button"
						class="section-toggle"
						id="usageExampleToggle"
						aria-expanded="false"
						aria-controls="usageExampleBody"
						onclick="toggleUsageExample()"
					>
						<span class="section-toggle-label">
							<strong>ä½¿ç”¨æ¡ˆä¾‹</strong>
							<span class="section-toggle-badge">å¯å±•å¼€æŸ¥çœ‹ç¤ºä¾‹</span>
						</span>
						<span class="section-toggle-icon" aria-hidden="true">âŒ„</span>
					</button>
					<div id="usageExampleBody" class="section-body is-collapsed">
						<p class="note">
							å‡è®¾è¡¨åä¸º <code>user_info</code>ï¼ŒExcel
							ä¸­çš„æ•°æ®å¦‚ä¸‹ï¼ˆç¬¬ä¸€è¡Œä¸ºåˆ—åï¼Œåé¢ä¸ºæ•°æ®è¡Œï¼‰ï¼š
						</p>
						<div style="overflow-x: auto">
							<table class="table">
								<thead>
									<tr>
										<th>id</th>
										<th>name</th>
										<th>age</th>
										<th>status</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>1</td>
										<td>Alice</td>
										<td>20</td>
										<td>ACTIVE</td>
									</tr>
									<tr>
										<td>2</td>
										<td>Bob</td>
										<td>30</td>
										<td>INACTIVE</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div style="margin-top: 8px">
							<div class="note">
								<strong>SELECT ç¤ºä¾‹</strong>ï¼ˆè¯­å¥ç±»å‹é€‰æ‹©
								<code>SELECT</code>ï¼Œæ¡ä»¶åˆ—æ•°å¯ç•™ç©ºï¼‰ï¼š
							</div>
							<pre
								class="code-block"
								style="
									white-space: pre-wrap;
									word-wrap: break-word;
									overflow-wrap: break-word;
								"
							>
SELECT * FROM `user_info` WHERE `id` IN ('1', '2') AND `name` IN ('Alice', 'Bob') AND `age` IN ('20', '30') AND `status` IN ('ACTIVE', 'INACTIVE');</pre
							>
						</div>

						<div style="margin-top: 8px">
							<div class="note">
								<strong>INSERT ç¤ºä¾‹</strong>ï¼ˆè¯­å¥ç±»å‹é€‰æ‹©
								<code>INSERT</code>ï¼Œæ¡ä»¶åˆ—æ•°å¯ç•™ç©ºï¼‰ï¼š
							</div>
							<pre
								class="code-block"
								style="
									white-space: pre-wrap;
									word-wrap: break-word;
									overflow-wrap: break-word;
								"
							>
INSERT INTO `user_info` (`id`, `name`, `age`, `status`) VALUES 
('1', 'Alice', '20', 'ACTIVE'), 
('2', 'Bob', '30', 'INACTIVE');</pre
							>
						</div>

						<div style="margin-top: 8px">
							<div class="note">
								<strong>UPDATE ç¤ºä¾‹</strong>ï¼ˆè¯­å¥ç±»å‹é€‰æ‹©
								<code>UPDATE</code>ï¼Œæ¡ä»¶åˆ—æ•°å¡«å†™ <code>1</code>ï¼Œä½¿ç”¨ç¬¬ 1 åˆ—
								<code>id</code> ä½œä¸º WHERE æ¡ä»¶ï¼‰ï¼š
							</div>
							<pre class="code-block">
UPDATE `user_info` SET `name` = 'Alice', `age` = '20', `status` = 'ACTIVE' WHERE `id` = '1';
UPDATE `user_info` SET `name` = 'Bob', `age` = '30', `status` = 'INACTIVE' WHERE `id` = '2';</pre
							>
						</div>

						<div style="margin-top: 8px">
							<div class="note">
								<strong>DELETE ç¤ºä¾‹</strong>ï¼ˆè¯­å¥ç±»å‹é€‰æ‹©
								<code>DELETE</code>ï¼Œæ¡ä»¶åˆ—æ•°å¡«å†™ <code>2</code>ï¼ŒæŒ‰å‰ä¸¤åˆ—
								<code>id</code> + <code>name</code> åˆ é™¤ï¼‰ï¼š
							</div>
							<pre class="code-block">
DELETE FROM `user_info` WHERE `id` = '1' AND `name` = 'Alice';
DELETE FROM `user_info` WHERE `id` = '2' AND `name` = 'Bob';</pre
							>
						</div>
					</div>
				</div>

				<div th:if="${error}" class="error" th:text="${error}">å‘ç”Ÿé”™è¯¯</div>
				<div th:if="${success}" class="success" th:text="${success}">
					æ“ä½œæˆåŠŸ
				</div>

				<form
					class="form"
					th:action="@{/excel/generate}"
					method="post"
					enctype="multipart/form-data"
				>
					<div class="form-row">
						<label for="databaseName">æ•°æ®åº“åº“åï¼ˆéå¿…å¡«ï¼‰</label>
						<input
							id="databaseName"
							name="databaseName"
							type="text"
							placeholder="è¯·è¾“å…¥æ•°æ®åº“åº“å"
							th:value="${databaseName}"
						/>
					</div>
					<div class="form-row">
						<label for="tableName">æ•°æ®åº“è¡¨å</label>
						<input
							list="tableNameList"
							id="tableName"
							name="tableName"
							type="text"
							placeholder="è¯·è¾“å…¥æ•°æ®åº“è¡¨åæˆ–ä»åˆ—è¡¨é€‰æ‹©"
							th:value="${tableName}"
							onchange="autoFillDatabaseName()"
						/>
						<datalist id="tableNameList"></datalist>
						<!-- <span class="note">å¯ç›´æ¥è¾“å…¥æˆ–ä»å­—å…¸é€‰æ‹©</span> -->
						<button type="button" class="btn ghost" onclick="openDictPicker()">
							ä»å­—å…¸é€‰æ‹©
						</button>
					</div>
					<div class="form-row">
						<label for="sqlType">è¯­å¥ç±»å‹</label>
						<select
							id="sqlType"
							name="sqlType"
							th:onchange="toggleWhereCount()"
						>
							<option
								th:each="t : ${sqlTypes}"
								th:value="${t}"
								th:text="${t}"
								th:selected="${t == sqlTypeSelected}"
							></option>
						</select>
					</div>
					<div class="form-row">
						<label for="whereColumnCount">æ¡ä»¶åˆ—æ•°</label>
						<input
							id="whereColumnCount"
							name="whereColumnCount"
							type="number"
							min="1"
							placeholder="è¯·è¾“å…¥æ•°å­—"
							th:value="${whereColumnCount}"
						/>
					</div>
					<div
						th:replace="~{fragments/file_upload :: uploadField('file','file','.xls,.xlsx','ä¸Šä¼  Excel æ–‡ä»¶','é€‰æ‹© Excel æ–‡ä»¶')}"
					></div>
					<div class="actions">
						<button type="submit">å’»ï½ï½ï½</button>
						<a class="btn secondary" th:href="@{/excel/template}"
							>ä¸‹è½½æ ‡å‡†æ¨¡æ¿</a
						>
						<a class="btn ghost" href="/tables">ç®¡ç†è¡¨åº“å­—å…¸</a>
					</div>
				</form>

				<div th:if="${outputPath}" class="result">
					<div>
						<strong>è¾“å‡ºè·¯å¾„ï¼š</strong
						><span th:text="${outputPath}">/path/to/output.sql</span>
					</div>
					<div style="margin-top: 8px">
						<a class="btn" th:if="${downloadUrl}" th:href="${downloadUrl}"
							>ä¸‹è½½ç”Ÿæˆçš„ SQL æ–‡ä»¶</a
						>
					</div>
				</div>

				<div th:if="${outputPath}" class="result">
					<div th:if="${previewContent}" style="margin-top: 12px">
						<div><strong>é¢„è§ˆï¼š</strong></div>
						<pre
							class="code-block"
							style="max-height: 360px; overflow: auto; white-space: pre-wrap"
							th:text="${previewContent}"
						></pre>
					</div>
					<div th:if="${previewTooLarge}" class="note" style="margin-top: 8px">
						ç”Ÿæˆå†…å®¹è¾ƒå¤§ï¼Œä¸ºé¿å…é¡µé¢å¡é¡¿ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œä¸‹è½½ç”Ÿæˆçš„ SQL
						æ–‡ä»¶â€åä½¿ç”¨æœ¬åœ°ç¼–è¾‘å™¨æŸ¥çœ‹ã€‚
					</div>
				</div>
			</div>
		</div>

		<!-- å­—å…¸é€‰æ‹©å¼¹çª— -->
		<div id="dictModal" class="modal" aria-hidden="true">
			<div class="modal-card">
				<div
					style="
						display: flex;
						align-items: center;
						justify-content: space-between;
						margin-bottom: 10px;
					"
				>
					<h2 style="margin: 0; font-size: 16px">ä»å­—å…¸é€‰æ‹©è¡¨å/åº“å</h2>
					<button type="button" class="btn ghost" onclick="closeDictPicker()">
						å…³é—­
					</button>
				</div>
				<div class="form" style="margin-bottom: 10px">
					<div class="form-row">
						<label for="dictFilterTable">è¡¨ååŒ…å«</label>
						<input
							id="dictFilterTable"
							type="text"
							placeholder="è¾“å…¥å…³é”®å­—è¿‡æ»¤"
						/>
					</div>
					<div class="form-row">
						<label for="dictFilterDb">åº“ååŒ…å«</label>
						<input id="dictFilterDb" type="text" placeholder="è¾“å…¥å…³é”®å­—è¿‡æ»¤" />
					</div>
				</div>
				<div style="overflow-x: auto; max-height: 50vh; overflow-y: auto">
					<table class="table">
						<thead>
							<tr>
								<th style="width: 72px">ID</th>
								<th>è¡¨å</th>
								<th>åº“å</th>
								<th>å¤‡æ³¨</th>
								<th style="width: 120px">æ“ä½œ</th>
							</tr>
						</thead>
						<tbody id="dictTbody">
							<tr>
								<td colspan="5">åŠ è½½ä¸­...</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div th:replace="~{fragments/layout_footer :: layoutFooter}"></div>

		<script>
			function toggleWhereCount() {
				var select = document.getElementById("sqlType");
				var input = document.getElementById("whereColumnCount");
				var v = select && select.value ? select.value.toUpperCase() : "";
				if (v === "UPDATE" || v === "DELETE") {
					input.removeAttribute("disabled");
				} else {
					input.setAttribute("disabled", "disabled");
					input.value = "";
				}
			}
			// åˆå§‹è½½å…¥æ ¹æ®å·²é€‰å€¼è°ƒæ•´
			document.addEventListener("DOMContentLoaded", function () {
				toggleWhereCount();
				// è½½å…¥è¡¨åå€™é€‰
				try {
					fetch("/api/tables")
						.then((r) => (r.ok ? r.json() : Promise.reject()))
						.then((data) => {
							var dl = document.getElementById("tableNameList");
							if (!dl) return;
							dl.innerHTML = "";
							(data || []).forEach(function (item) {
								var opt = document.createElement("option");
								opt.value = item.tableName;
								opt.label = item.databaseName
									? item.tableName + "  Â·  " + item.databaseName
									: item.tableName;
								dl.appendChild(opt);
							});
						})
						.catch(() => {});
				} catch (e) {}
			});
			function autoFillDatabaseName() {
				var name = document.getElementById("tableName")?.value || "";
				if (!name) return;
				try {
					fetch("/api/tables/lookup?name=" + encodeURIComponent(name))
						.then((r) => (r.ok ? r.json() : Promise.reject()))
						.then((d) => {
							if (d && d.databaseName) {
								var db = document.getElementById("databaseName");
								if (db && !db.value) db.value = d.databaseName;
							}
						})
						.catch(() => {});
				} catch (e) {}
			}
			function onFileSelected() {
				var input = document.getElementById("file");
				var name =
					input && input.files && input.files.length ? input.files[0].name : "";
				var span = document.getElementById("fileNameDisplay");
				if (span) span.textContent = name ? "å·²é€‰æ‹©ï¼š" + name : "";
			}
			function toggleUsageExample() {
				var body = document.getElementById("usageExampleBody");
				var toggle = document.getElementById("usageExampleToggle");
				if (!body || !toggle) return;
				var expanded = toggle.getAttribute("aria-expanded") === "true";
				if (expanded) {
					toggle.setAttribute("aria-expanded", "false");
					toggle.classList.remove("is-open");
					body.classList.add("is-collapsed");
				} else {
					toggle.setAttribute("aria-expanded", "true");
					toggle.classList.add("is-open");
					body.classList.remove("is-collapsed");
				}
			}
			// å­—å…¸é€‰æ‹©å™¨
			var __dictCache = null;
			function openDictPicker() {
				var modal = document.getElementById("dictModal");
				if (!modal) return;
				if (!__dictCache) {
					loadDictData()
						.then(renderDictTable)
						.catch(function () {
							renderDictTable([]);
						});
				} else {
					renderDictTable(__dictCache);
				}
				modal.classList.add("open");
				modal.setAttribute("aria-hidden", "false");
				bindDictFilters();
			}
			function closeDictPicker() {
				var modal = document.getElementById("dictModal");
				if (!modal) return;
				modal.classList.remove("open");
				modal.setAttribute("aria-hidden", "true");
			}
			function loadDictData() {
				return fetch("/api/tables")
					.then((r) => (r.ok ? r.json() : Promise.reject()))
					.then(function (data) {
						__dictCache = Array.isArray(data) ? data : [];
						return __dictCache;
					});
			}
			function bindDictFilters() {
				var fTable = document.getElementById("dictFilterTable");
				var fDb = document.getElementById("dictFilterDb");
				if (fTable) {
					fTable.oninput = applyDictFilter;
				}
				if (fDb) {
					fDb.oninput = applyDictFilter;
				}
			}
			function applyDictFilter() {
				var kwTable = (
					document.getElementById("dictFilterTable")?.value || ""
				).toLowerCase();
				var kwDb = (
					document.getElementById("dictFilterDb")?.value || ""
				).toLowerCase();
				var list = (__dictCache || []).filter(function (i) {
					var t = (i.tableName || "").toLowerCase();
					var d = (i.databaseName || "").toLowerCase();
					var okT = !kwTable || t.includes(kwTable);
					var okD = !kwDb || d.includes(kwDb);
					return okT && okD;
				});
				renderDictTable(list);
			}
			function renderDictTable(list) {
				var tbody = document.getElementById("dictTbody");
				if (!tbody) return;
				if (!list || list.length === 0) {
					tbody.innerHTML = '<tr><td colspan="5">æš‚æ— è®°å½•</td></tr>';
					return;
				}
				tbody.innerHTML = "";
				list.forEach(function (i) {
					var tr = document.createElement("tr");
					var tdId = document.createElement("td");
					tdId.textContent = i.id;
					var tdT = document.createElement("td");
					tdT.textContent = i.tableName || "";
					var tdD = document.createElement("td");
					tdD.textContent = i.databaseName || "";
					var tdR = document.createElement("td");
					tdR.textContent = i.remark || "";
					var tdA = document.createElement("td");
					var btn = document.createElement("button");
					btn.className = "btn";
					btn.type = "button";
					btn.textContent = "é€‰æ‹©";
					btn.onclick = function () {
						var tInput = document.getElementById("tableName");
						var dInput = document.getElementById("databaseName");
						if (tInput) tInput.value = i.tableName || "";
						if (dInput) dInput.value = i.databaseName || "";
						closeDictPicker();
					};
					tdA.appendChild(btn);
					tr.appendChild(tdId);
					tr.appendChild(tdT);
					tr.appendChild(tdD);
					tr.appendChild(tdR);
					tr.appendChild(tdA);
					tbody.appendChild(tr);
				});
			}
		</script>
	</body>
</html>
